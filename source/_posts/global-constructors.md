---
title: Clang Global Constructors
date: 2023-08-07 13:37:53
tags:
  - compilers
  - computer science
  - LLVM
  - clang
  - frontend
category: Science
---

# Global Constructors Generated by Clang

## Background

In [ReportFunctionExecutedPass](https://github.com/SecurityLab-UCD/ReportFunctionExecutedPass),
we are trying to build a customized C/C++ compiler for our research project to gather IO pairs of functions when fuzzing.
We achieve this goal by building an LLVM Function Pass and using it as a plugin when compiling with clang.
Recently, we discovered that if the target program includes `<iostream>`,
the compiled executable will always result in a **floating point exception**.

## Reproduction

```cpp
#include <iostream>
int main() { return 0; }
```

## Debugging

After diagnosing the issue,
I found that the problem is caused by
[inserting into a hash table](https://github.com/SecurityLab-UCD/ReportFunctionExecutedPass/blob/60ed2c299a060c36afd644ba86d9613d9cca7c7b/ExecHashMap.hpp#L109).
Since the key of the table is a `std::string`,
I suspected that the problem arises from hashing a string.
To verify this, I attempted to avoid using a hash by changing the `unordered_map` to a `map`.
However, the problem still persisted.
Now, `table.find()` works fine, but `table.insert()` still triggers the exception.

Next, I used a debugger to step into the `insert()` function and
discovered that the exception is caused by reporting `__cxx_global_var_init` and `_GLOBAL__sub_I_example.cpp`.
These two functions are only reported when `#include <iostream>` is used.

Upon further investigation,
I found that these two functions are
[global constructors](https://discourse.llvm.org/t/static-constructors-cxx-global-var-initn-vs-global-sub-i-xxx/39442)
generated by the clang frontend.
However, these functions do not meet our requirements for the functions to be reported,
so I ignore them in the pass to ensure the compiled executable functions properly.
